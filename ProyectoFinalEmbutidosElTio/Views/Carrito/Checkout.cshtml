@model ProyectoFinalEmbutidosElTio.Models.ViewModels.CartViewModel
@{
    ViewData["Title"] = "Checkout";
}

<div class="bg-gray-50 min-h-screen py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <div class="text-center mb-10">
            <h1 class="text-3xl font-extrabold text-gray-900">Finalizar Compra</h1>
            <p class="text-gray-500 mt-2">Completa tu pedido de forma segura</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- Payment Section -->
            <div class="space-y-6">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-sm">1</span>
                        MÃ©todo de Pago
                    </h2>

                    <form id="checkoutForm" asp-action="ConfirmOrder" method="post">
                        <div class="space-y-4">
                            <!-- QR Payment Option -->
                            <label class="relative flex p-5 border border-gray-200 rounded-xl cursor-pointer focus:outline-none hover:bg-orange-50 hover:border-orange-200 transition-all group">
                                <input type="radio" name="paymentMethod" value="QR" class="h-4 w-4 mt-0.5 border-gray-300 text-orange-600 focus:ring-orange-500" checked>
                                <div class="ml-3 flex flex-col">
                                    <span class="block text-sm font-medium text-gray-900 group-hover:text-orange-700">QR Simple / Transferencia</span>
                                    <span class="block text-sm text-gray-500">Escanea y paga al instante desde tu banca mÃ³vil.</span>
                                </div>
                                <div class="ml-auto flex items-center text-gray-400">
                                    ðŸ“±
                                </div>
                            </label>

                            <!-- Cash Option -->
                            <label class="relative flex p-5 border border-gray-200 rounded-xl cursor-pointer focus:outline-none hover:bg-orange-50 hover:border-orange-200 transition-all group">
                                <input type="radio" name="paymentMethod" value="Cash" class="h-4 w-4 mt-0.5 border-gray-300 text-orange-600 focus:ring-orange-500">
                                <div class="ml-3 flex flex-col">
                                    <span class="block text-sm font-medium text-gray-900 group-hover:text-orange-700">Pago Contra Entrega</span>
                                    <span class="block text-sm text-gray-500">Paga en efectivo al recibir tu pedido.</span>
                                </div>
                                <div class="ml-auto flex items-center text-gray-400">
                                    ðŸ’µ
                                </div>
                            </label>

                            <!-- PayPal Option -->
                            <label class="relative flex p-5 border border-gray-200 rounded-xl cursor-pointer focus:outline-none hover:bg-orange-50 hover:border-orange-200 transition-all group">
                                <input type="radio" name="paymentMethod" value="Paypal" class="h-4 w-4 mt-0.5 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <div class="ml-3 flex flex-col">
                                    <span class="block text-sm font-medium text-gray-900 group-hover:text-blue-700">PayPal</span>
                                    <span class="block text-sm text-gray-500">Paga con tu saldo PayPal o tarjeta.</span>
                                </div>
                                <div class="ml-auto flex items-center text-blue-500 font-bold">
                                    PP
                                </div>
                            </label>

                             <!-- Stripe Option -->
                            <label class="relative flex p-5 border border-gray-200 rounded-xl cursor-pointer focus:outline-none hover:bg-orange-50 hover:border-orange-200 transition-all group">
                                <input type="radio" name="paymentMethod" value="Stripe" class="h-4 w-4 mt-0.5 border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <div class="ml-3 flex flex-col">
                                    <span class="block text-sm font-medium text-gray-900 group-hover:text-indigo-700">Tarjeta (Stripe)</span>
                                    <span class="block text-sm text-gray-500">Paga seguro con tarjeta de crÃ©dito/dÃ©bito.</span>
                                </div>
                                <div class="ml-auto flex items-center text-indigo-500 font-bold">
                                    ðŸ’³
                                </div>
                            </label>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Summary Section -->
            <div>
                 <div class="bg-gray-900 rounded-2xl shadow-xl border border-gray-800 p-8 text-white">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                         <span class="w-8 h-8 rounded-full bg-orange-600 text-white flex items-center justify-center text-sm">2</span>
                         Resumen
                    </h2>

                    <div class="flow-root mb-8">
                        <ul role="list" class="-my-4 divide-y divide-gray-700">
                            @foreach (var item in Model.Items)
                            {
                                <li class="py-4 flex justify-between gap-4">
                                    <div>
                                        <h3 class="text-sm font-medium text-white">@item.Producto.Nombre</h3>
                                        <p class="text-sm text-gray-400">Cant: @item.Quantity</p>
                                    </div>
                                    <p class="text-sm font-medium text-orange-400">$@item.Subtotal.ToString("N2")</p>
                                </li>
                            }
                        </ul>
                    </div>

                    <div class="border-t border-gray-700 pt-6 space-y-4">
                         <div class="flex items-center justify-between text-gray-300">
                            <span>Subtotal</span>
                            <span>$@Model.Total.ToString("N2")</span>
                        </div>
                        <div class="flex items-center justify-between text-base font-bold text-white">
                            <span>Total a Pagar</span>
                            <span class="text-2xl text-orange-500">$@Model.Total.ToString("N2") USD</span>
                        </div>
                    </div>

                    <div id="defaultActions">
                        <button type="submit" form="checkoutForm" class="w-full mt-8 bg-orange-600 border border-transparent rounded-xl shadow-lg py-4 px-4 font-bold text-white hover:bg-orange-700 hover:shadow-orange-500/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-orange-500 transition-all">
                            Confirmar Pedido
                        </button>
                    </div>

                    <!-- PayPal Button Container (Hidden by default) -->
                    <div id="paypal-button-container" class="mt-8 hidden"></div>

                    <!-- Stripe Button (Hidden by default) -->
                    <button id="stripe-button" class="hidden w-full mt-8 bg-indigo-600 border border-transparent rounded-xl shadow-lg py-4 px-4 font-bold text-white hover:bg-indigo-700 hover:shadow-indigo-500/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-indigo-500 transition-all">
                        Pagar con Tarjeta (Stripe)
                    </button>
                    
                    <p class="mt-4 text-center text-xs text-gray-500">
                        Al confirmar, aceptas nuestros tÃ©rminos de servicio.
                    </p>
                 </div>
            </div>

        </div>
    </div>
</div>
@section Scripts {
    <script src="https://www.paypal.com/sdk/js?client-id=@ViewBag.PayPalClientId&currency=USD"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe('@ViewBag.StripePublicKey');
        const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
        const defaultActions = document.getElementById('defaultActions');
        const paypalContainer = document.getElementById('paypal-button-container');
        const stripeButton = document.getElementById('stripe-button');

        // Toggle Payment Options
        paymentRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                // Reset All
                defaultActions.classList.add('hidden');
                paypalContainer.classList.add('hidden');
                stripeButton.classList.add('hidden');

                if (e.target.value === 'Paypal') {
                    paypalContainer.classList.remove('hidden');
                } else if (e.target.value === 'Stripe') {
                    stripeButton.classList.remove('hidden');
                } else {
                    defaultActions.classList.remove('hidden');
                }
            });
        });

        // Stripe Payment Handler
        stripeButton.addEventListener('click', function () {
            fetch('/Carrito/CreateStripeSession', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
            .then(function (response) {
                if (!response.ok) {
                     return response.json().then(err => { throw new Error(err.error || "Error " + response.status); });
                }
                return response.json();
            })
            .then(function (session) {
                return stripe.redirectToCheckout({ sessionId: session.sessionId });
            })
            .then(function (result) {
                if (result && result.error) {
                    alert(result.error.message);
                }
            })
            .catch(function (error) {
                console.error('Error detallado:', error);
                alert('Error al conectar con Stripe: ' + error.message);
            });
        });

        // PayPal Payment Handler
        paypal.Buttons({
            createOrder: function(data, actions) {
                return fetch('/Carrito/CreatePayPalOrder', {
                    method: 'post'
                }).then(function(res) {
                    if (!res.ok) {
                        return res.json().then(json => { throw new Error(json.message || 'Error creating order'); });
                    }
                    return res.json();
                }).then(function(orderData) {
                    if (!orderData.id) {
                         throw new Error('No Order ID returned');
                    }
                    return orderData.id;
                }).catch(function(err) {
                    console.error('PayPal CreateOrder Error:', err);
                    alert('No se pudo iniciar el pago con PayPal. Por favor intenta de nuevo.\nDetalles: ' + err.message);
                });
            },
            onApprove: function(data, actions) {
                return fetch('/Carrito/CapturePayPalOrder?orderId=' + data.orderID, {
                    method: 'post'
                }).then(function(res) {
                    return res.json();
                }).then(function(orderData) {
                    if (orderData.success) {
                        window.location.href = "/Carrito/PaymentSuccess/" + orderData.orderId;
                    } else {
                        alert('Error en el pago: ' + orderData.message);
                    }
                });
            }
        }).render('#paypal-button-container');
    </script>
}
